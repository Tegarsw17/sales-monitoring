<%- include('./templates/header.html') -%>
  <div class="z-50 sticky top-0 flex flex-col">
    <nav class="w-screen h-15 p-2 bg-[#fBfBfB] text-2xl flex justify-between items-center">
      <a href="/"><i class="fa-solid fa-angle-left"></i></a>
      <p>
        <%= title %>
      </p>
      <i class="fa fa-arrow-left invisible"></i>
    </nav>
  </div>
  <div class="flex justify-center items-center h-64 m-1 rounded bg-[#fbfbfb]">
    <img id="hasil-foto" src="" alt="" class="h-full" />
    <div class="flex flex-col justify-center items-center" id="data-foto">
      <label for="upload-photo"><i class="fa-solid fa-camera fa-3x"></i></label>
      <p>Take Photo</p>
    </div>
  </div>
  <input onchange="previewFile()" type="file" accept="image/*" id="upload-photo" class="invisible" capture />
  <div class="flex justify-center">
    <div class="grid grid-cols-1 w-10/12 justify-items-center">
      <button id="getLocation" class="bg-[#007FFF] text-white p-3 rounded w-full justify-self-center">
        Get Location
      </button>
      <p id="findLocation" class="mt-1 text-lg text-[#0B6BCC]"></p>

      <button onclick="postLocation()" class="bg-[#007FFF] text-white p-3 rounded w-24 mt-3 justify-self-end">
        <i class="fa-solid fa-arrow-right-long"></i>
      </button>
    </div>
  </div>
  <%- include('./templates/navbar.html') -%>
    <script>
      let getLocation = document.getElementById("getLocation");
      let addText = document.getElementById("findLocation");
      let kecamatan = ""
      // let kelurahan = ""
      let latitude = ""
      let longitude = ""

      getLocation.addEventListener("click", function () {
        const success = (position) => {
          const latitudePost = position.coords.latitude;
          const longitudePost = position.coords.longitude;
          // addText.textContent = `latitude:${latitudePost} longitude:${longitudePost}`;
          addText.textContent = `Lokasi berhasil ditemukan`;
          const getApi = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitudePost}&longitude=${longitudePost}&localityLanguage=en`;

          const dataLocation = axios.get(getApi).then(function (response) {
            kecamatan += response.data.locality
            // kelurahan += "-"
            latitude += response.data.latitude
            longitude += response.data.longitude
            getLocation.disabled = true;
          })
        };
        const err = (err) => {
          addtext.textContent = err.message;
        };
        navigator.geolocation.getCurrentPosition(success, err, {
          enableHighAccuracy: true,
          timeout: 5000,
        });
      });

      function previewFile() {
        var preview = document.querySelector("img");
        var file = document.querySelector("input[type=file]").files[0];
        var nonPreview = document.getElementById("data-foto");
        var reader = new FileReader();

        reader.onloadend = function () {
          preview.src = reader.result;
        };

        if (file) {
          reader.readAsDataURL(file);
          nonPreview.remove();
        } else {
          preview.src = "";
        }
      }

      function postLocation() {
        // hit data post tulisan
        try {
          // apakah data sudah diisi semua
          // if (!token) throw err
          const dataLocation = axios.post('v1/api/track', {
            lock_latitude: latitude,
            lock_longitude: longitude,
            kecamatan: kecamatan,
            // kelurahan: kelurahan
          }, {
            headers: {
              'authorization': token,
              'Content-Type': 'application/x-www-form-urlencoded'
            }
          })
          // hit data post gambar
          var file = document.querySelector("input[type=file]").files[0];
          console.log(file)
          const imageLocation = axios.post('v1/api/imagetrack', { file: file }, {
            headers: {
              'authorization': token,
              'Content-Type': 'multipart/form-data'
            }
          })
          successAlert(
            `Laporan berhasil dibuat`,
            "/"
          )
        } catch (error) {
          errorAlert(
            `Laporan gagal dibuat`,
            window.location.href
          )

        }
      }
    </script>
    <%- include('./templates/footer.html') -%>